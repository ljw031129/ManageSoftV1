@{
    ViewBag.Title = "协议管理";
    Layout = "../Shared/_LayoutFlattyMain.cshtml";
}
@section styles{

}
<div class='row' id='content-wrapper'>
    <div class='col-xs-12' ng-controller="ProCtrl">
        <div class='row'>
            <div class='col-sm-12'>
                <div class='page-header'>
                    <h1 class='pull-left'>
                        <i class='icon-user'></i>
                        <span>协议管理</span>
                    </h1>
                    <div class='pull-right'>
                        <ul class='breadcrumb'>
                            <li>
                                <a href='index.html'>
                                    <i class='icon-bar-chart'></i>
                                </a>
                            </li>
                            <li class='separator'>
                                <i class='icon-angle-right'></i>
                            </li>
                            <li>Example pages</li>
                            <li class='separator'>
                                <i class='icon-angle-right'></i>
                            </li>
                            <li class='active'>User profile</li>
                        </ul>
                    </div>
                </div>

            </div>
        </div>
        <div class="row">
            <div class="col-sm-12">
                <div style="margin-bottom:0;" class="box bordered-box blue-border">
                    <div class="box-header blue-background">
                        <div class="title">基本类型</div>
                        <div class="actions">
                            <a href="#" class="btn box-remove btn-xs btn-link">
                                <i class="icon-remove"></i>
                            </a>

                            <a href="#" class="btn box-collapse btn-xs btn-link">
                                <i></i>
                            </a>
                        </div>
                    </div>
                    <div class="box-content box-no-padding">
                        <div class="responsive-table">
                            <div class="scrollable-area">
                                <table class="table table-bordered table-hover table-condensed">
                                    <thead>
                                        <tr>
                                            <th>Id</th>
                                            <th>
                                                协议名称
                                            </th>
                                            <th>
                                                协议版本号
                                            </th>
                                            <th>
                                                解析方式
                                            </th>
                                            <th>信息体个数位置</th>
                                            <th>信息体标志位置</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr ng-repeat="prData in PmFInterpreters">
                                            <td>{{prData.PmFInterpreterId}}</td>
                                            <td>{{prData.ProtocolName}}</td>
                                            <td>{{prData.ProtocolVersion}}</td>
                                            <td>{{prData.AnalysisWay}}</td>
                                            <td>{{prData.InfoSignStartPosition}}</td>
                                            <td>
                                                {{prData.InfoSignLength}}
                                            </td>
                                            <td>
                                                <div class="text-center">
                                                    <a href="#" class="btn btn-success btn-xs">
                                                        <i class=" icon-search " ng-click="loadDataBody(prData)"></i>
                                                    </a>                                                   
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <hr class="hr-double">
        <div class="row">
            <div class="col-sm-12">
                <div style="margin-bottom:0;" class="box purple-border blue-border">
                    <div class="box-header  purple-background">
                        <div class="title">解析协议配置信息</div>
                        <div class="actions">
                            <a href="#" class="btn btn-xs btn-link">
                                <i class="icon-plus" ng-click="addDataBody()"></i>
                            </a>

                            <a href="#" class="btn box-remove btn-xs btn-link">
                                <i class="icon-remove"></i>
                            </a>

                            <a href="#" class="btn box-collapse btn-xs btn-link">
                                <i></i>
                            </a>
                        </div>
                    </div>
                    <div class="box-content box-no-padding">
                        <div class="responsive-table">
                            <div class="scrollable-area">
                                <table class="table table-bordered table-hover table-condensed">
                                    <thead>
                                        <tr style="font-weight: bold">
                                            <td width="60">编号</td>
                                            <td width="60">信息体</td>
                                            <td width="80">截取位置</td>
                                            <td width="80">截取长度</td>
                                            <td width="80">处理方式</td>
                                            <td width="80">目标类型</td>
                                            <td width="80">传输模式</td>
                                            <td width="60">符号位</td>
                                            <td width="80">计算公式</td>
                                            <td width="90">存储Key值</td>
                                            <td>bit数据</td>
                                            <td>操作</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr ng-repeat="dataBody in DataBodys">
                                            <td>
                                                <!-- editable username (text with validation) -->
                                                <span class="label label-success"> {{ $index  }}</span>

                                            </td>
                                            <td>
                                                <!-- editable username (text with validation) -->
                                                <span editable-text="dataBody.InfoTypeNumber" e-name="InfoTypeNumber" e-form="rowform">
                                                    {{ dataBody.InfoTypeNumber }}
                                                </span>
                                            </td>
                                            <td>
                                                <!-- editable status (select-local) -->
                                                <span editable-text="dataBody.StartPosition" e-name="StartPosition" e-form="rowform">
                                                    {{ dataBody.StartPosition }}
                                                </span>
                                            </td>
                                            <td>
                                                <!-- editable group (select-remote) -->
                                                <span editable-text="dataBody.DataLength" e-name="DataLength" e-form="rowform">
                                                    {{ dataBody.DataLength }}
                                                </span>
                                            </td>
                                            <td>
                                                <!-- editable status (select-local) -->
                                                <span editable-select="dataBody.DataType" e-name="DataType" e-form="rowform" e-ng-options="s.value as s.text for s in DataTypes">
                                                    {{ showTypes(dataBody.DataType) }}
                                                </span>
                                            </td>
                                            <td>
                                                <!-- editable status (select-local) -->
                                                <span editable-select="dataBody.PmDataByte.Representation" e-name="Representation" e-form="rowform" e-ng-options="s.value as s.text for s in Representations">
                                                    {{ showRepresentations(dataBody.PmDataByte.Representation) }}
                                                </span>
                                            </td>
                                            <td>
                                                <!-- editable status (select-local) -->
                                                <span editable-select="dataBody.PmDataByte.IsBigEndian" e-name="IsBigEndian" e-form="rowform" e-ng-options="s.value as s.text for s in boolData">
                                                    {{ showBool(dataBody.PmDataByte.IsBigEndian) }}
                                                </span>
                                            </td>
                                            <td>
                                                <!-- editable status (select-local) -->
                                                <span editable-select="dataBody.PmDataByte.IsUnsigned" e-name="IsUnsigned" e-form="rowform" e-ng-options="s.value as s.text for s in boolData">
                                                    {{ showBool(dataBody.PmDataByte.IsUnsigned) }}
                                                </span>
                                            </td>
                                            <td>
                                                <!-- editable status (select-local) -->
                                                <span editable-text="dataBody.PmDataByte.Formula" e-name="Formula" e-form="rowform">
                                                    {{ dataBody.PmDataByte.Formula }}
                                                </span>
                                            </td>
                                            <td>
                                                <!-- editable status (select-local) -->
                                                <span editable-select="dataBody.PmDataByte.DictionaryKey" e-name="DictionaryKey" e-form="rowform" e-ng-options="m for m in SelectReceiveData">
                                                    {{ dataBody.PmDataByte.DictionaryKey }}
                                                </span>
                                            </td>
                                            <td>
                                                <table class="table table-bordered table-hover" ng-show="dataBody.DataType==2">
                                                    <thead>
                                                        <tr>
                                                            <td width="60">编号</td>
                                                            <td width="60">开始位置</td>
                                                            <td width="60">长度</td>
                                                            <td width="60">存储字段</td>
                                                            <td><button class="btn btn-primary btn-xs" ng-click="addBitDatas(dataBody)" ng-disabled="!rowform.$visible"><span class="glyphicon  glyphicon-plus"></span></button></td>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr ng-repeat="bitData in dataBody.PmDataBits">
                                                            <td><span class="label label-success">{{$index}}</span></td>
                                                            <td><span editable-text="bitData.ChildStartPostion" e-name="ChildStartPostion" e-form="rowform">{{bitData.ChildStartPostion}}</span></td>
                                                            <td><span editable-text="bitData.ChildDataLength" e-name="ChildDataLength" e-form="rowform">{{bitData.ChildDataLength}}</span></td>
                                                            <td><span editable-select="bitData.DictionaryKey" e-name="DictionaryKey" e-form="rowform" e-ng-options="m for m in SelectReceiveData">{{bitData.DictionaryKey}}</span></td>
                                                            <td><button class="btn btn-danger btn-xs" ng-click="delBitDatas(dataBody,$index,bitData)"><span class="glyphicon  glyphicon-trash"></span></button></td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </td>
                                            <td style="white-space: nowrap">
                                                <!-- form -->
                                                <form editable-form name="rowform" onaftersave="pmDataBodySave($data, dataBody.PmDataBodyId)" ng-show="rowform.$visible" class="form-buttons form-inline" shown="inserted == dataBody">
                                                    <button type="submit" ng-disabled="rowform.$waiting" class="btn btn-success btn-xs">
                                                        <span class="glyphicon glyphicon-ok"></span>
                                                    </button>
                                                    <button type="button" ng-disabled="rowform.$waiting" ng-click="rowform.$cancel()" class="btn btn-danger  btn-xs">
                                                        <span class="glyphicon  glyphicon-remove"></span>
                                                    </button>
                                                </form>
                                                <div class="buttons" ng-show="!rowform.$visible">
                                                    <button ng-click="rowform.$show()" class="btn btn-primary btn-xs" type="submit"><span class="glyphicon glyphicon-pencil"></span> </button>
                                                    <button ng-click="removePro($index)" class="btn btn-danger  btn-xs" type="submit"><span class="glyphicon  glyphicon-trash"></span> </button>

                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <hr class="hr-double">

    </div>
</div>

@section scripts{

    <script type="text/javascript">

        app.controller('ProCtrl', function ($scope, $filter, $http) {

            $scope.DataBodys = null;
            $scope.SelectpmFInterpreter = null;
            $scope.SelectReceiveData = null;
            $http.get('/ProtocolManage/GetPropertyInfoArrayByReceiveDataLast').success(function (data) {
                $scope.SelectReceiveData = data;
            });
            //加载基本信息数据
            $http.get('/ProtocolManage/GetAll').success(function (data) {
                $scope.PmFInterpreters = data;
            });
            $scope.loadDataBody = function (pmFInterpreter) {
                $scope.SelectpmFInterpreter = pmFInterpreter;
                $http.get('/ProtocolManage/GetPmDataBodyById',
                    { params: { pmId: pmFInterpreter.PmFInterpreterId } }).success(function (data) {
                        $scope.DataBodys = data;
                    });
            }
            $scope.pmDataBodySave = function (data, pmid) {
                //  angular.extend(data, { id: pmid });
                var guidStr = getGuidGenerator();
                var data = $filter('filter')($scope.DataBodys, { PmDataBodyId: pmid });
                if (data[0].DataType == "1" && data[0].PmDataByte.PmDataByteId == null) {
                    data[0].PmDataByte.PmDataByteId = guidStr;
                    var idx = $scope.DataBodys.indexOf(data[0]);
                    $scope.DataBodys[idx].PmDataByte.PmDataByteId = guidStr;
                }
                //协议类型ID
                data[0].PmFInterpreterId = $scope.SelectpmFInterpreter.PmFInterpreterId;
                return $http.post('/ProtocolManage/UpdateDataBody', data[0]).success(function (reData) {

                });
            };
            $scope.DataTypes = [
              { value: 1, text: '字节' },
              { value: 2, text: 'BIT位' },
              { value: 3, text: '状态位' }

            ];
            $scope.Representations = [
             { value: 1, text: '整数' },
             { value: 2, text: '字符串' },
             { value: 3, text: '时间' },
             { value: 4, text: '不处理' },
             { value: 5, text: '温度' },
             { value: 6, text: '电压' }
            ];

            $scope.boolData = [
            { value: true, text: '是' },
            { value: false, text: '否' }
            ];
            $scope.showTypes = function (currentType) {

                var selected = $filter('filter')($scope.DataTypes, { value: currentType });
                return (currentType && selected.length) ? selected[0].text : '未设置';
            };
            $scope.showRepresentations = function (currentType) {

                var selected = $filter('filter')($scope.Representations, { value: currentType });
                return (selected.length) ? selected[0].text : '未设置';
            };
            $scope.showBool = function (curentData) {
                var selected = $filter('filter')($scope.boolData, { value: curentData });
                return (selected.length) ? selected[0].text : '未设置';
            }
            $scope.addBitDatas = function (data) {
                var idx = $scope.DataBodys.indexOf(data);
                $scope.insertData = {
                    "PmDataBitId": getGuidGenerator(),
                    "Representation": 0,
                    "ByteCounts": 0,
                    "IsBigEndian": false,
                    "BitType": 0,
                    "ChildStartPostion": 1,
                    "ChildDataLength": 2,
                    "DefaultValue": null,
                    "DictionaryKey": "A2"
                };

                $scope.DataBodys[idx].PmDataBits.push($scope.insertData);
            }
            $scope.delBitDatas = function (dataBody, cIndex, bitData) {

                var idx = $scope.DataBodys.indexOf(dataBody);
                var st = $scope.DataBodys[idx];
                $scope.DataBodys[idx].PmDataBits.splice(cIndex, 1);
                //执行后台删除操作
                return $http.post('/ProtocolManage/DeletePmDataBits', bitData).success(function (reData) {

                });
            }
            // remove user
            $scope.removePro = function (index) {
                var dataBodys = $scope.DataBodys[index];
                dataBodys.PmFInterpreterId = $scope.SelectpmFInterpreter.PmFInterpreterId;

                $scope.DataBodys.splice(index, 1);
                return $http.post('/ProtocolManage/DeletePmDataBody', dataBodys).success(function (reData) {

                });
               
            };            
            $scope.addDataBody = function () {
                $scope.inserted = {
                    PmDataBodyId: getGuidGenerator(),
                    InfoTypeNumber: "1",
                    StartPosition: 0,
                    DataLength: 1,
                    DataType: 2,
                    PmDataByte: {
                        "PmDataByteId": getGuidGenerator(),
                        "Representation": 2,
                        "IsBigEndian": true,
                        "IsUnsigned": false,
                        "Formula": "($*0.1)",
                        "DefaultValue": "默认值",
                        "DictionaryKey": "A1"
                    },
                    PmDataBits: [
                            {
                                "PmDataBitId": getGuidGenerator(),
                                "Representation": 0,
                                "ByteCounts": 0,
                                "IsBigEndian": false,
                                "BitType": 0,
                                "ChildStartPostion": 1,
                                "ChildDataLength": 2,
                                "DefaultValue": null,
                                "DictionaryKey": "A2"
                            }
                    ]
                };
                $scope.DataBodys.push($scope.inserted);
            };

        });
        //生成随机的GUID
        function getGuidGenerator() {
            var S4 = function () {
                return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
            };
            return (S4() + S4() + "-" + S4() + "-" + S4() + "-" + S4() + "-" + S4() + S4() + S4());
        }
    </script>
}
