@using Microsoft.AspNet.Identity
@model SocialGoal.Model.ViewModels.OrgStructureViewModel

@{
    ViewBag.Title = "Register";

}
@Styles.Render("~/Content/Flatty/Css")
<link href="~/Scripts/plugins/select2-3.5.1/select2.css" rel="stylesheet" />
<link href="~/Scripts/plugins/select2-3.5.1/select2-bootstrap.css" rel="stylesheet" />
<link href="~/Content/assets/stylesheets/plugins/dynatree/ui.dynatree.css" rel="stylesheet" />
<div class="container">
    <div class="row">
        <div class="col-sm-12">
            @using (Ajax.BeginForm("Creat", "OrgStructure", null, new AjaxOptions
      {
          UpdateTargetId = "UserLogOnContainer",
          HttpMethod = "Post",
          OnSuccess = " ",
      },
     new { @class = "form form-horizontal" })
   )
            {
                @Html.ValidationSummary(true, "Account creation was unsuccessful. Please correct the errors and try again.")
                <div class='form-group'>
                    <label class="col-xs-4 control-label">所属企业</label>
                    <div class='col-xs-8'>
                        <input type="text" placeholder="搜索企业" name="OrgEnterpriseId" id="OrgEnterpriseId" class="form-control">
                    </div>
                </div>
                 <div class='form-group'>
                    <label class="col-xs-4 control-label">父节点</label>
                    <div class='col-xs-8'>
                        <div id="citySel" class="select2-container input-block-level">
                            <a class="select2-choice" tabindex="-1" id="menuBtn" href="#">
                                <span>；；；</span>
                                <div>
                                    <b></b>
                                </div>
                            </a>
                        </div>
                        <div id="menuContent" class="menuContent select2-drop">
                            <ul id="treeDemo" style="margin:0;"></ul>
                        </div>
                    </div>
                </div>
                <div class='form-group'>
                    @Html.LabelFor(m => m.OrgStructureNum, new { @class = "col-xs-4 control-label" })
                    <div class='col-xs-8'>
                        @Html.TextBoxFor(m => m.OrgStructureNum, new { @class = "form-control" })
                        @Html.ValidationMessageFor(m => m.OrgStructureNum)
                    </div>
                </div>
                <div class='form-group'>
                    @Html.LabelFor(m => m.OrgStructureName, new { @class = "col-xs-4 control-label" })
                    <div class='col-xs-8'>
                        @Html.TextBoxFor(m => m.OrgStructureName, new { @class = "form-control" })
                        @Html.ValidationMessageFor(m => m.OrgStructureName)
                    </div>
                </div>
                <div class='form-group'>
                    @Html.LabelFor(m => m.OrgStructureDescribe, new { @class = "col-xs-4 control-label" })
                    <div class='col-xs-8'>
                        @Html.TextBoxFor(m => m.OrgStructureDescribe, new { @class = "form-control" })
                        @Html.ValidationMessageFor(m => m.OrgStructureDescribe)
                    </div>
                </div>
                <div class="form-actions form-actions-padding-sm">
                    <div class="row">
                        <div class="col-md-10 col-md-offset-2">
                            <button class="btn btn-primary" type="submit">
                                <i class="icon-save"></i>
                                保存
                            </button>
                            <button class="btn" type="submit">取消</button>
                        </div>
                    </div>
                </div>

            }
        </div>
    </div>
</div>
<script src="~/Scripts/jquery-2.1.1.min.js"></script>
<script src="~/Content/assets/javascripts/plugins/dynatree/jquery.dynatree.min.js"></script>
<script src="@Url.Content("~/Scripts/jquery.validate.min.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Scripts/jquery.validate.unobtrusive.min.js")" type="text/javascript"></script>
<script src="~/Scripts/plugins/select2-3.5.1/select2.js"></script>
<script src="~/Scripts/plugins/select2-3.5.1/select2_locale_zh-CN.js"></script>
<script type="text/javascript">
    $(document).ready(function () {
        var userId="noLogin";
        if ( "@User.Identity.IsAuthenticated" ) {
            userId="@User.Identity.GetUserId()";
        }

        @*var attendeeUrl = '@Url.Action("GetOrgEnterprises", "OrgEnterprise")';*@
        var attendeeUrl = "http://localhost:9898/api/ApiOrgEnterprise/GetOrgEnterprisesSelect";
        var pageSize = 20;
        $('#OrgEnterpriseId').select2(
               {
                   placeholder: 'Enter name',
                   //Does the user have to enter any data before sending the ajax request
                   minimumInputLength: 0,
                   allowClear: true,
                   ajax: {
                       //How long the user has to pause their typing before sending the next request
                       quietMillis: 150,
                       //The url of the json service
                       url: attendeeUrl,
                       dataType: 'json',
                       //Our search term and what page we are on
                       data: function (term, page) {
                           return {
                               pageSize: pageSize,
                               pageNum: page,
                               searchTerm: term,
                               userId: userId
                               };
                       },
                       results: function (data, page) {
                           //Used to determine whether or not there are more results available,
                           //and if requests for more data should be sent in the infinite scrolling
                           var more = (page * pageSize) < data.Total;
                           return { results: data.Results, more: more };
                       }
                   }
               });

        $("#treeDemo").dynatree({
            selectMode: 2,
            initAjax: "http://localhost:9898/api/ApiOrgStructure/GetOrgStructureTree/" + userId,
            onActivate: function (node) {
                if (node.data.title !== 0) {
                    enterpriseID = node.data.key;
                    var selVal = $("#citySel").find("span");
                    selVal.text(node.data.title);
                    hideMenu();
                    tbl.fnDraw();
                }

            }

        });
    });
</script>